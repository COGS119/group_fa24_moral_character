<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
  <!-- load in the vignette js-->
  <script src="stimuli/stimuli_vignette.js"></script>
  <script src="stimuli/stimuli_questions.js"></script>
  <link href="https://unpkg.com/jspsych@8.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function () {
   //   jsPsych.data.displayData();
    }
  });

  console.log(QUESTIONS);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p"+random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
        random_id: random_id,
      });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  /* create timeline */
  var timeline = [];

  var full_screen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
  }

  timeline.push(full_screen);

  console.log(VIGNETTES[0])

  var condition_assignment = jsPsych.randomization.sampleWithoutReplacement(['moral', 'immoral'], 1)[0];

  var stimulus_item_list = [];

  for (i=0; i<VIGNETTES.length; i++) {
    cur_stim = VIGNETTES[i];

    if (cur_stim["item_type"]==condition_assignment) {
      stimulus_item_list.push(cur_stim)
    }

  }

  var stimulus_item = stimulus_item_list[0];

  console.log(stimulus_item);
  console.log(stimulus_item["item_type"])
  console.log(stimulus_item["text"])
  
  /* load in stimulus list */
  // IDEA: store the vignette text as a variable in .js code (loaded above)
  // each element in the variable VIGNETTES is one of the two prompts, structured as html
  // you can view the structure by looking in the console
  // console.log(VIGNETTES)

  //let's store one of these elements
  console.log("Assigned Condition:", condition_assignment);
  console.log("Stimulus Item:", stimulus_item);
  // MAIN TO DO: How can we systematically assign participants to one of the vignettes/ conditions?

  //define likert scale labels for each question
  //we have seven options, so seven entries. We need to *at least* specify the extremes of the scale.
  var speed_likert = [
    "very slowly",
    "",
    "",
    "",
    "",
    "",
    "very quickly"
  ];

  var impulsivity_likert = [
    "very cautious",
    "",
    "",
    "",
    "",
    "",
    "very impulsive"
  ];

  var certainty_likert = [
    "very doubtful",
    "",
    "",
    "",
    "",
    "",
    "very certain"
  ];

  var moral_likert = [
    "very immoral",
    "",
    "",
    "",
    "",
    "",
    "very moral"
  ];


  /* Adding survey for data collection */

  var trial = {
    type: jsPsychSurveyHtmlForm,
    html: `
      <label>Enter your Participant ID (PID): <input name="pid" type="text" required></label><br><br>
      <label>What is your age in years? <input name="age" type="number" required></label><br><br> 
      <label>What is your gender? 
        <select name="gender" required>
          <option value="" disabled selected>Select your option</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </label>
    `
  };
  timeline.push(trial);

  /* Instructions page */
  var instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<p>Welcome to the study! In this experiment, you will read about two individuals, Justin and Nate.</p>
                <p>After each story, you will be asked to evaluate their actions and character through a series of questions.</p> 
               <p>Please read the stories carefully and answer the questions to the best of your ability.</p>
               <p>Click 'Continue' to proceed.</p>`,
    choices: ['Continue']
  };

  timeline.push(instructions);



  // here's how we can show a given vignette trial
  // TO DO: what else do we need to add to the trial procedure? What other information should we store? How can we turn this into a complete experiment timeline?
  var trial_scenario = {
    type: jsPsychHtmlButtonResponse,
    //add the vignette as text at the top 
    //(could also present the vignette integrated with the questions - what are the pros and cons of doing so?)
    stimulus: stimulus_item['text'],
    choices: ["Continue"],
    // store elements from the stimulus item
    data: {
      item_type: stimulus_item['item_type']
    }
  }
  timeline.push(trial_scenario);


  // Randomly assign condition to either 'moral' or 'immoral'
//var condition_assignment = jsPsych.randomization.sampleWithoutReplacement(['moral', 'immoral'], 1)[0];


var justin_list = QUESTIONS.filter(q => q.name === "justin" && q.item_type === condition_assignment);
var nate_list = QUESTIONS.filter(q => q.name === "nate" && q.item_type === condition_assignment);

console.log("Filtered Justin Questions:", justin_list);
console.log("Filtered Nate Questions:", nate_list);

// Dynamically set preambles based on condition
var justin_preamble = condition_assignment === "moral" 
    ? "<p>Justin was able to decide quickly. He decided not to steal the money.</p>" 
    : "<p>Justin was able to decide quickly. He decided to pocket the money and drive off.</p>";

var nate_preamble = condition_assignment === "moral" 
    ? "<p>Nate took a long time to decide not to steal the money.</p>" 
    : "<p>Nate took a long time to decide and ultimately decided to pocket the money.</p>";

console.log("Justin Preamble:", justin_preamble);
console.log("Nate Preamble:", nate_preamble);


// Create Justin and Nate questions
var justin_questions = { 
    type: jsPsychSurveyLikert, 
    preamble: justin_preamble,
    questions: justin_list.map(q => ({
        prompt: q.text,
        required: true,
        labels: q.options,
        name: q.item
    }))
}; 

var nate_questions = { 
    type: jsPsychSurveyLikert, 
    preamble: nate_preamble,
    questions: nate_list.map(q => ({
        prompt: q.text,
        required: true,
        labels: q.options,
        name: q.item
    }))
}; 


// Create Manipulation Check Questions object
var mc_questions = { 
    type: jsPsychSurveyLikert, 
    preamble: "<p>Please answer the following questions about the decision-making process.</p>",  // Reminder Preamble
    questions: MC_QUESTIONS.map(q => ({
        prompt: q.text, 
        required: true, 
        labels: q.options, 
        name: q.item_type
    }))
}; 

// Push all questions to the timeline
timeline.push(mc_questions, justin_questions, nate_questions);

var feedback = {
  type: jsPsychSurveyText,
  questions: [
    {prompt: "What do you think the experiment was about?", rows: 4, columns: 50},
    {prompt: "Did you encounter any technical issues? If yes, please describe them.", rows: 4, columns: 50}
  ]
};
timeline.push(feedback);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "oPoskIYymX6Y",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS



  
  var debrief = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<p>Thank you for participating!</p>
             <p>This study examines how decision speed affects perceptions of moral character.</p>
             <p>Your responses will help us better understand how people evaluate others' actions.</p>
             <p>Click 'Finish' to complete the study.</p>`,
  choices: ['Finish']
};
timeline.push(debrief);

// remove jsPsych.data.displayData();

var full_screen = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
  }

  timeline.push(full_screen);

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>